<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>WebDALI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style type="text/css">
      .light-name { height: 1em; overflow-y: hidden; }
      .light-widget { margin: 1em auto 0 auto; }
      .light { float: left; width: 5em; overflow: hidden; margin: 0 5px 0 5px; text-align: center}
      .slider-collection { float: left; }
      .slider { float: left; margin: 0em; border: 2px solid red; padding: 25px; }
      .slider-widget { margin:auto; }
      .timer { width: 3em; font-size: 1em;}
      .timer-add { margin-top: 1em; }
      .onoff { margin-top: 1em;}

    </style>
    <script type="text/javascript" src="../lib/jqueryui/js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="../lib/underscore.js"></script>
    <script type="text/javascript" src="../lib/backbone.js"></script>
    <script type="text/javascript" src="../lib/jqueryui/js/jquery-ui-1.8.21.custom.min.js"></script>
    <script type="text/javascript" src="../lib/jstree/jquery.jstree.js"></script>
    <script type="text/javascript" src="slider.js"></script>
    <link rel="stylesheet" href="../lib/jqueryui/css/ui-lightness/jquery-ui-1.8.21.custom.css" />

  </head>
  <body>
    <div class="bar" id="sliders"></div> <br/> <br/>
    <div class="sliderX" id="examplesliderX"></div> <br /> <br />
    <input type="button" id="newslider" value="New slider" />
    <script type="text/javascript">
    var SliderCollection = Backbone.Collection.extend ({
	  	model: Slider.Slider,
	  	lightIds : [],
	  	parentEl: null,
	  	//sliderList: JSON.stringify(new Object()),
	  	sliderList: {},
	  
	  	url: function() {
	  		return "../server2/data/"+this.lightIds
			},
		
	  	initialize: function() {
	    	//this.on ("add", function (m, c) { c.sync()});
	  	},
	  
	  	newSlider: function(lightList, parentEl) {
		  	this.lightIds = lightList;
		  	
		  	// No parents in first creation
		  	if (parentEl)
		  		this.parentEl = parentEl;
		  		
		  	this.fetch();
	  	},
	  
	  	parse: function(response) {
	  		var childWrap = null;
	  		
	  		for (var i in response) {
	  			var curLight = response[i];

	  			// Create a new slider
	    		this.add ({ name: curLight["name"], value: curLight["current_level"], 
		  		children: curLight["children"], allChildren: curLight["all_children"], 
		  		collection: this, lightID: curLight["permanent_id"] });
		  		
		  		// Keep record of sliders with a certain ID
		  		var cid = curLight["permanent_id"];
		  		if (! this.sliderList[cid])
		  			this.sliderList[cid] = [];
		  		this.sliderList[cid].push(this.models[this.length-1])
		  		//console.log("tree", this.sliderList);
		  		
					if (this.parentEl) {
						// Create an element for children
						if (! childWrap) {
							childWrap = $("<div class='bar' />");
							this.parentEl.$el.after(childWrap);
							this.parentEl.model.set("childElement", childWrap);
						}
						// Insert the child into the element
			  		var childEl = $(".slider:last");
			  		childWrap.append(childEl);
					}
		  	}
		  	if (childWrap) {
				  childWrap.hide();
				  childWrap.show("fade", 300);
				}
				
				return this.models;
	 		},
		});

    var SliderCollectionView = Backbone.View.extend ({
	  	tagName: "div",
	  	className: "slider-collection",

	  	initialize: function() {
	      var _this = this;
	      this.model.on ("add", function (m, c) { _this.$el.append (new Slider.SliderView ({model: m}).$el)});
	      this.render();
	  	},

	  	render: function() {
	      //console.log ("rendered");
	      this.$el.empty();
	      var _this = this;
	      this.model.each (function (x) { _this.$el.append (new Slider.SliderView ({model: x}).$el)});
	  	}
    });
    
		//var Foo = new Slider.Slider();
		//Foo.startTimer();
		//var fooView = new Slider.SliderView({model: Foo, el: $("#exampleslider")});
			
    var Sliders = new SliderCollection();
    var SlidersView = new SliderCollectionView ({ model: Sliders, el: $("#sliders") });
      
    //Sliders.on ("add", function() { console.log ("added")});
			
    //$("#newslider").bind ("click", function () { Sliders.add ({ value: 0 })});
		$("#newslider").bind ("click", function () { Sliders.newSlider([6]); });
			
		Sliders.newSlider([6,1], null);
    </script>
  </body>

</html>
