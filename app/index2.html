<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>WebDALI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <script type="text/javascript" src="../lib/jqueryui/js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="../lib/underscore.js"></script>
    <script type="text/javascript" src="../lib/backbone.js"></script>
    <script type="text/javascript" src="../lib/backbone-relational.js"></script>
    <script type="text/javascript" src="../lib/jqueryui/js/jquery-ui-1.8.21.custom.min.js"></script>
    <script type="text/javascript" src="../lib/jstree/jquery.jstree.js"></script>
    <script type="text/javascript" src="../lib/jquery.idTabs.min.js"></script>
    <script //type="text/javascript" src="light.js"></script>
    <script type="text/javascript" src="program.js"></script>
    <script type="text/javascript" src="time.js"></script>
    <script type="text/javascript" src="programlevel.js"></script>
    <script type="text/javascript" src="slider.js"></script>
    <script //type="text/javascript" src="programline.js"></script>
    <script //type="text/javascript" src="programlist.js"></script>
    <link rel="stylesheet" href="../lib/jqueryui/css/ui-lightness/jquery-ui-1.8.21.custom.css" />
    <link rel="stylesheet" href="../lib/idTabStyle.css" />
		<link rel="stylesheet" href="../app2/style.css" type="text/css" />
  </head>
  <body>
    <!-- lightGroups contains the tree of light groups. It's currently a jstree that's generated once and then only ever moved to different
	 places in the document as necessary. -->
    <div id="lightGroups"></div>

    <!-- The page structure proper and the various container elements -->
    <div id="container">
    	<div id="usual" class="usual">

    		<ul class="tabs testi">
      		<li><a href="#mainpage">Etusivu</a></li>
      		<li><a href="#groups">Valoryhmät</a></li>
      		<li><a href="#programs">Uusi sääntö</a></li>
      		<li><a href="#sliders">Uusi virtuaalikytkin</a></li>
      		<li style='display: none'><a href="#programsEdit"></a></li>
    		</ul>
    
    		<div id="mainpage" class="divit"><h2>Etusivu</h2>
      		<table class="programs" id="programsList">
      		</table>
    		</div>
    
    		<div id="groups" class="divit"><h2>Valoryhmät</h2>
      		<div id="groupContainer" class="programs">
						<div id="groupsLightGroups"></div>
						<div id="groupAdd" class="eiVierekkain">
	  					<input id="addGroup" type="submit" value="Add" />
						</div>
    			</div>
    			<div id="groupRemove" class="eiVierekkain">
						<input id="deleteGroup" type="submit" value="Remove group" />
    			</div>
    		</div>

    		<div id="programs" class="divit"><h2>Uusi sääntö</h2>
    			<div class='programError' id="programsErrorMain"></div>
    			<div>
    				Säännön nimi:
    				<br />
    				<input id='programName' />
    			</div>
    			<div id="programTimesContainer">
    				<div id="programTimes"></div>
    				<input id="addTime" type="submit" value="+Lisää aika" />
    			</div>
    			
					<div id='ProgramLevelsContainer'>
	    			<div id="ProgramLevels"></div>
	    			<input id="addProgramSlider" type="submit" value="+Lisää ryhmä" />
					</div>
					<input id="saveProgram" type=button value="Tallenna" />
    		</div>
    		
    		<div id="sliders" class="divit"><h2>Uusi virtuaalikytkin</h2>
    			<div>
	      		<input id='slidersIDs' value="jstree tähän"/>
	      	</div>
	      	<div>
	      		Kopioitava HTML-koodi:
	      		<br />
	      		<textarea id="sliderCode" type="textarea" rows="15" cols="40">
	      		</textarea>
					</div>
    		</div>
    		
    		<div id="programsEdit" class="divit"><h2>Muokkaa sääntöä</h2>
    			<div class='programError' id="programsErrorMain"></div>
    			<div>
    				Säännön nimi:
    				<input id='programEditName' />
    			</div>
    			<div id="programTimesContainer">
    				<div id="programEditTimes"></div>
    				<input id="addEditTime" type="submit" value="+Lisää aika" />
    			</div>
    			
					<div id='ProgramEditLevelsContainer'>
	    			<div id="programEditSliders"></div>
	    			<input id="addEditProgramSlider" type="submit" value="+Lisää ryhmä" />
					</div>
					<input id="saveEditProgram" type=button value="Tallenna" />
    		</div>
    		
    	</div>
    </div>
    
    <script type="text/javascript">
      // jstree needs this to load its CSS
      $.jstree._themes="../lib/jstree/themes/";

      // turned out not to be needed on the development machines with the .htaccess in server/
      // see T38
//      Backbone.emulateHTTP = true;
      $("#usual ul").idTabs(true);
      //var Programs = new ProgramList.ProgramList;

      // Grab the list of programs from the server; see T60
//      Programs.fetch({async: false}); 

			errorMessages = { 
				0:"Ohjelman nimen on oltava 1-32 merkkiä pitkä.",
				1:"Valitse vähintään yksi viikonpäivä.",
				2:"Kellonajan täytyy olla muotoa TT:MM.",
				3:"Ohjelmalla on oltava vähintään yksi aika-asetus.",
				4:"Ohjelmalla on oltava vähintään yksi ryhmäasetus.",
				5:"Aloitusajan on oltava lopetusaikaa pienempi.",
				6:"Tämä ryhmä on jo käytössä toisessa valotasossa.",
			};
		
      // Set up the light groups page
      $("#deleteGroup").bind ("click", function() { $.jstree._reference("#lightGroups").remove() });
      $("#addGroup").bind ("click", function() { $.jstree._reference ("#lightGroups").create() });
      $("#lightGroups").hide();

			// New program page
      $("#programName").bind ("change", function() { Programs.where({id:null})[0].set("name", $("#programName").val()); });
      $("#addTime").bind ("click", function() { tempTimes.add({}); });
      $("#addProgramSlider").bind ("click", function() { tempProgramLevels.add({}); });
      $("#saveProgram").bind ("click", function() { Programs.where({id:null})[0].save(null, {
      	success: function(m,r) {
      		// TODO: ID insert here
      		m.set("id", r);
      	},
      	
      	error: function(m,r) {
      		r = JSON.parse(r.responseText);
      		
      		// Clear old errors
      		$("#programsErrorMain").empty();
      		
      		for (i in tempTimes.models)
      			tempTimes.models[i].set("errors", null);
      		
      		for (i in tempProgramLevels.models)
      			tempProgramLevels.models[i].set("errors", null);
      			
      		// Display errors
      		for (var i in r["main_errors"])
      			$("#programsErrorMain").append(errorMessages[r["main_errors"][i]]+"<br />");
      			
      		for (var i in r["time_errors"]) {
      			var cTime = tempTimes.where({cid:i})[0];
						cTime.set("errors", r["time_errors"][i]);
      		}
      		
      		for (var i in r["level_errors"]) {
      			var cLevel = tempProgramLevels.where({cid:i})[0];
						cLevel.set("errors", r["level_errors"][i]);
      		}
      	}
      }); });

			// Edit program page
      $("#programEditName").bind ("change", function() { Programs.models[0].set("name", $("#programEditName").val()); });
      $("#addEditTime").bind ("click", function() { tempTimes.add({}); });
      $("#addEditProgramSlider").bind ("click", function() { tempProgramLevels.add({}); });
      $("#saveEditProgram").bind ("click", function() { Programs.models[0].save(null, {
      	success: function(m,r) {
      		// TODO: Need to change tab here
      	},
      	error: function() {
      		console.log("ERRORO");
      	}
      }); });

      $("#lightGroups").jstree ({
	  		"json_data": {
	      	// the url from which jstree loads its information
	      	// (note that updating to the server is done "out of view" from jstree, in callbacks below)
	      	"ajax": { "url": "../server/lightsTree" }
	  		},
	  		// allow selecting groups and their members independently
	  		"checkbox": {
  	    	"two_state": "false",
  	    },
	  		// note T4, T5, T6; this is currently a no-op
	  		"types": {
	      	"light": { max_children: 0 }
	  		},
	  		"plugins": ["themes", "json_data", "checkbox", "ui", "dnd", "crrm", "types"]
	  	})

    .bind("rename.jstree", function (e, data) {
			console.log (data.rslt.obj.attr("id"));
			$.post(
	    	"../server/lights/" + data.rslt.obj.attr("id") + "/name", 
				JSON.stringify ({ "name" : data.rslt.new_name }), 
				
				function (r) {
			    if(r !== "{}")
						$.jstree.rollback(data.rlbk);
				}
			);
		})
		
    .bind("dblclick.jstree", function () { 
			$("#lightGroups").jstree("rename", null)
    })

    .bind("move_node.jstree", function (e, data) {
			console.log (data);
				$.post ("../server/lights/" + data.rslt.o.attr("id") + "/parent",
			
				JSON.stringify ({
		 	   "parent" : data.rslt.cr === -1 ? 1 : data.rslt.np.attr("id")
				}),
		
				function (r) {
		    	if(r !== "{}")
						$.jstree.rollback(data.rlbk);
				}
			);
    })

    .bind("remove.jstree", function (e, data) {
			data.rslt.obj.each(function () {
	    	$.ajax({
					async : false,
					type: 'DELETE',
					url: "../server/lights/" + this.id,
					success : function (r) {
		    		if(r !== "{}")
							data.inst.refresh();
					}
	    	});
			});
    })
    
    // create a new node
    // note T65
    .bind("create.jstree", function (e, data) {
    console.log(data.rslt);
			$.post (
	    	"../server2/lights",
	    	JSON.stringify ({ name: data.rslt.name}),
			function (r) {
		    var res = JSON.parse (r);
		    if (r['error'] !== undefined)
					$.jstree.rollback(data.rlbk);
		    else {
					$(data.rslt.obj).attr("id", r);
					data.inst.refresh();
		    }
			})
    });
    
    $.jstree._reference($("#lightGroups")).hide_checkboxes();


		/*
		// Light programs collection
		*/
		var ProgramCollection = Backbone.Collection.extend ({
			model: Program.Program,
			url: "../server2/programs/",
		});
		
		var ProgramCollectionView = Backbone.View.extend ({
			tagName: "div",
			className: 'program-collection',
			
			initialize: function() {
				var _this = this;
				this.model.on ("add", function (m, c) { _this.$el.append (new Program.ProgramView ({model: m}).$el)});
				//this.render();
			},

			render: function() {
				this.$el.empty();
				var _this = this;
				this.model.each (function (x) { _this.$el.append (new Program.ProgramView ({model: x}).$el)});
			}
		});
		
		var ProgramCollectionMainView = Backbone.View.extend ({
			tagName: "div",
			className: 'program-collection',
			
			initialize: function() {
				var _this = this;
				this.model.on ("add", function (m, c) { _this.$el.append (new Program.ProgramMainView ({model: m, router: appRouter}).$el)});
				this.model.on("reset", function() { _this.render(); });
			},

			render: function() {
				this.$el.empty();
				var _this = this;
				this.model.each (function (x) { _this.$el.append (new Program.ProgramMainView ({model: x}).$el); x.set("router", AppRouter); });
			}
		});
		
		/*
		// Programs time collection
		*/
		var TimeCollection = Backbone.Collection.extend ({
			model: Time.Time,
			url: "../server2/times/",
			
			getErrorMessage: function($id) {
				return(errorMessages[$id]);
			},
		});
		
		var TimeCollectionView = Backbone.View.extend ({
			tagName: "div",
			className: 'time-collection',
			
			initialize: function() {
				var _this = this;
				this.model.on ("add", function (m, c) { _this.$el.append (new Time.TimeView ({model: m}).$el); });
				this.model.on("reset", function() { _this.render(); });

				//this.render();
			},

			render: function() {
				this.$el.empty();
				var _this = this;
				this.model.each (function (x) { _this.$el.append (new Time.TimeView ({model: x}).$el); });
			},
		});
		
		/*
		// Light & motion detector settings for programs
		*/
		var ProgramSliderCollection = Backbone.Collection.extend ({
			model: ProgramSlider.ProgramSlider,
			url: "../server2/levels/",
			
			getErrorMessage: function($id) {
				return(errorMessages[$id]);
			},
		});
		
		var ProgramSliderCollectionView = Backbone.View.extend ({
			tagName: "div",
			className: 'programslider-collection',

			initialize: function() {
				var _this = this;
				this.model.on ("add", function (m, c) { _this.$el.append (new ProgramSlider.ProgramSliderView ({model: m}).$el)});
				//this.render();
			},

			render: function() {
				this.$el.empty();
				var _this = this;
				this.model.each (function (x) { _this.$el.append (new ProgramSlider.ProgramSliderView ({model: x}).$el)});
			}
		});
		
		// Collection instances for permanent programs
		var Programs = new ProgramCollection();
		var ProgramsView = new ProgramCollectionView ({ model: Programs, el: $("#current_program") });
		var ProgramsMainView = new ProgramCollectionMainView ({ model: Programs, el: $("#programsList") });

		var Times = new TimeCollection();  
    var TimesView = new TimeCollectionView ({ model: Times, el: $("#programTimes") });
    
    var ProgramLevels = new ProgramSliderCollection();
    var ProgramLevelsView = new ProgramSliderCollectionView ({ model: ProgramLevels, el: $("#ProgramLevels") });
    
		// Collection instances for temporary programs
		//var tempPrograms = new ProgramCollection();
		//var tempProgramsView = new ProgramCollectionView ({ model: tempPrograms, el: $("#current_program") });

    var tempTimes = new TimeCollection();
    var tempTimesView = new TimeCollectionView ({ model: tempTimes, el: $("#programTimes") });

    var tempProgramLevels = new ProgramSliderCollection();
    var tempProgramLevelsView = new ProgramSliderCollectionView ({ model: tempProgramLevels, el: $("#ProgramLevels") });
    
    // Get programs from DB
		Programs.fetch({success: function() {console.log("Fetched",Programs);
		}});
		
    // Backbone.Router handles noticing where we're navigating to for us
    // (though see T36)
    var AppRouter = Backbone.Router.extend ({
			routes: {
				"mainpage": "mainpageView",
	    	"programs": "programsView",
	    	"programsEdit/:cid": "programsEditView",
	    	"groups": "groupsView",
	    	"sliders": "slidersView",
			},

			initialize : function () {
				this.lastPage = null;
				
				// Remove unsaved program when leaving new program page
				this.bind("all", function() {
					if (this.lastPage == "programs") {
						var cProg = Programs.where({id:null});
						Programs.remove(cProg);
					}
					this.lastPage = Backbone.history.fragment;
				});
			},
	// note that the various *view functions are of course run each time you navigate to a view
	// this means:
	// - don't bind events to already existing elements (because they'll get bound multiple times)
	//   (making new elements and binding events to those is okay, probably, although the optimal thing to do
	//   would probably be to ever rerender stuff if you can help it)
	// - don't load data if you could already have loaded it in the background earlier or bootstrapped it into the page
	
	mainpageView: function() {
	},
	
	controlsView: function() {
	    /*
	    $("#controlsLightGroups").empty();
	    $.jstree._reference($("#lightGroups")).show_checkboxes();
	    $("#lightGroups").show();
	    $("#controlsLightGroups").append($("#lightGroups"));
	    //var menu = new ProgramList.MultipleChoiceMenu ({ el: $("#controlsProgramsList"), model: Programs});
		*/
	},
	
	groupsView: function () {
			/*
			$.get("../server2/lightstree/");
	    //$("#groupsLightGroups").empty();
	    //$.jstree._reference($("#lightGroups")).hide_checkboxes();
	    $("#lightGroups").show();
	    $("#groupsLightGroups").append($("#lightGroups"));
			*/
	},
	
	slidersView: function() {
		_this = this;
		
		var req = $(document).ready(function() {
				$.get('../app2/index-text.html', 
				function(data) {
						console.log(sliderHTML);
						_this.sliderHTML = data;
				});
		});
		console.log(sliderHTML);
	},
	
	programsView: function () {
	    /*
	    $("#programsLightGroups").empty();
	    $.jstree._reference($("#lightGroups")).show_checkboxes();
	    $("#lightGroups").show();
	    $("#programsLightGroups").append($("#lightGroups"));
	    //var menu = new ProgramList.SingleChoiceMenu ({ el: $("#programsProgramList"), model: Programs});
			*/

			// Reset the view
			this.resetProgramsView();
			$("#programName").val('');
			tempTimesView.$el = $("#programTimes");
			tempProgramLevelsView.$el = $("#ProgramLevels");

			// Create a null ID program
			Programs.add({id:null});
			var newProg = _.last(Programs.models);
			
			console.log(Programs);
			newProg.set("times", tempTimes.models);
			newProg.set("levels", tempProgramLevels.models);
	},
	
	programsEditView: function (progID) {
		this.resetProgramsView();
		$(".selected").attr("class", "");
		
		//tempPrograms.add(cProg);
		//newProg = tempPrograms.models[0];
		//newProg = Programs.where({id:progID})[0];
		
		newProg = Programs.get(progID);
		var times = newProg.get("times");
		var levels = newProg.get("levels");
		
		$("#programEditName").val(newProg.get("name"));
		tempTimesView.$el = $("#programEditTimes");
		tempProgramLevelsView.$el = $("#programEditSliders");

		newProg.set("times", tempTimes.models);
		newProg.set("levels", tempProgramLevels.models);

		// Fill in the editing page
		for (var i in times)
			tempTimes.add(times[i]);
		for (var i in levels) 
			tempProgramLevels.add(levels[i]);
	},
	
	resetProgramsView: function () {
		
		// Empty models from temporary collections
		// TODO: Empty() function here
		for (var i=tempTimes.length-1; i>-1; i--) {
			cModel = tempTimes.models[i];
			tempTimes.remove(cModel);
		}
		for (var i=tempProgramLevels.length-1; i>-1; i--) {
			cModel = tempProgramLevels.models[i];
			tempProgramLevels.remove(cModel);
		}
	},
	
    });
    // I assume Backbone internally sets some global variable to make this work, because yes, this is needed to make the router run
    appRouter = new AppRouter;
    // we're done with everything, roll it
    Backbone.history.start();
    
    // Force starting from main page
    appRouter.navigate('mainpage', {trigger: true, replace: true});
    </script>
  </body>
</html>
