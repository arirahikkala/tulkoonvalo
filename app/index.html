<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>WebDALI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style type="text/css">
      .light-name { height: 1em; overflow-y: hidden; }
      .light-widget { margin: 1em auto 0 auto; }
      .light { float: left; width: 5em; overflow: hidden; margin: 0 5px 0 5px; text-align: center}
    </style>
    <script type="text/javascript" src="../lib/jqueryui/js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="../lib/underscore.js"></script>
    <script type="text/javascript" src="../lib/backbone.js"></script>
    <script type="text/javascript" src="../lib/backbone-relational.js"></script>
    <script type="text/javascript" src="../lib/jqueryui/js/jquery-ui-1.8.21.custom.min.js"></script>
    <script type="text/javascript" src="../lib/jstree/jquery.jstree.js"></script>
    <script type="text/javascript" src="../lib/jquery.idTabs.min.js"></script>
    <script type="text/javascript" src="light.js"></script>
    <script type="text/javascript" src="program.js"></script>
    <script type="text/javascript" src="programline.js"></script>
    <script type="text/javascript" src="programlist.js"></script>
    <link rel="stylesheet" href="../lib/jqueryui/css/ui-lightness/jquery-ui-1.8.21.custom.css" />
    <link rel="stylesheet" href="../lib/idTabStyle.css" />

  </head>
  <body>
    <!-- the lightGroups view is shared between multiple tabs, so, might as well make it "global" -->
    <div id="lightGroups"></div>

    <div id="container">
    <div id="usual" class="usual">
    <ul class="tabs">
      <li><a href="#controls">Controls</a></li>
      <li><a href="#groups">Groups</a></li>
      <li><a href="#programs">Programs</a></li>
      <li><a href="#help">Help</a></li>
      <li><a href="#test">(test)</a></li>
    </ul>
    <div id="controls" class="divit"><h2>Controls</h2>
      <div class="lights" id="controlsLightGroups"></div>
      <div class="programs" id="controlsProgramsList"></div>
      <div class="eiVierekkain" id="controlsProgram"></div>
      <div class="eiVierekkain" id="htmlEmbed"></div>
    </div>
    <div id="groups" class="divit"><h2>Groups</h2>
      <div id="groupContainer" class="programs">
	<div id="groupsLightGroups"></div>
	<div id="groupAdd" class="eiVierekkain">
	  <input id="addGroup" type="submit" value="Add" />
	</div>
      </div>
      <div id="groupRemove" class="eiVierekkain">
	<input id="deleteGroup" type="submit" value="Remove group" />
      </div>
    </div>
    <div id="programs" class="divit"><h2>Programs</h2>
      <div id="programsLightGroups" class="lights"></div>
      <div id="programsContainer" class="programs">
	<div id="programsProgramList"></div>
	<div id="createProgram" class="eiVierekkain"><input type='text' value='Name...' name='programName'/><input type='button' value='Add' name='cProgram'/></div>
      </div>
      <div id="deleteProgram" class="eiVierekkain"><input type="button" value="Delete program"></div>
      <div id="programSetup" class="eiVierekkain"></div>
    </div>
    <div id="help" class="divit">Help<br /></div>
    <div id="test" class="divit">Test<br /></div>
    </div>

    </div>
    <script type="text/javascript">
      $.jstree._themes="../lib/jstree/themes/";
      Backbone.emulateHTTP = true;
      $("#usual ul").idTabs(true);
      $("#deleteGroup").bind ("click", function() { $.jstree._reference("#lightGroups").remove() });
      $("#addGroup").bind ("click", function() { $.jstree._reference ("#lightGroups").create() });
      var Programs = new ProgramList.ProgramList;

      // todo: Bootstrap this into the page itself
      Programs.fetch({async: false}); 
      console.log (Programs);

      $("#lightGroups").hide();
      $("#lightGroups").jstree ({
	  "json_data": {
	      "ajax": {
		  "url": "../server/lightsTree"
	      }
	  },
	  "dnd": {
	      "drop_finish": function() { 
		  console.log ("dropped");
	      }
	  },
	  "checkbox": {
  	      "two_state": "false",

	  },
	  "types": {
	      "light": {
		  max_children: 0
	      }
	  },
	  "plugins": ["themes", "json_data", "checkbox", "ui", "dnd", "crrm", "types"]})
    .bind ("move_node.jstree check_node.jstree uncheck_node.jstree", function (e, d) { console.log (e); console.log (d);})
    .bind("rename.jstree", function (e, data) {
	console.log (data.rslt.obj.attr("id"));
	$.post(
	    "../server/lights/" + data.rslt.obj.attr("id") + "/name", 
			JSON.stringify ({
				"name" : data.rslt.new_name
			}), 
			function (r) {
			    if(r !== "{}") {
				$.jstree.rollback(data.rlbk);
			    }
			}
		);
	})
    .bind("dblclick.jstree", function () { 
	$("#lightGroups").jstree("rename", null)
    })
    .bind("move_node.jstree", function (e, data) {
	console.log (data);
	$.post ("../server/lights/" + data.rslt.o.attr("id") + "/parent",
		JSON.stringify ({
		    "parent" : data.rslt.cr === -1 ? 1 : data.rslt.np.attr("id")
		}),
		function (r) {
		    if(r !== "{}") {
			$.jstree.rollback(data.rlbk);
		    }
		}
	);
    })
	.bind("remove.jstree", function (e, data) {
		data.rslt.obj.each(function () {
			$.ajax({
				async : false,
				type: 'DELETE',
				url: "../server/lights/" + this.id,
				success : function (r) {
					if(r !== "{}") {
						data.inst.refresh();
					}
				}
			});
		});
	})
	.bind("create.jstree", function (e, data) {
	    $.post (
		"../server/lights",
		JSON.stringify ({
		    name: data.rslt.name}),
		function (r) {
		    var res = JSON.parse (r);
		    if (r['error'] !== undefined) {
			$.jstree.rollback(data.rlbk);
		    }
		    else {
			$(data.rslt.obj).attr("id", r);
			// todo: This refresh is used to put the newly generated node in the right place
			// it'd be better to just have it in the right place in the first place, that way
			// there would be no need to refresh (which closes the tree and is generally annoying)
			data.inst.refresh();
		    }
		})
	});
    $.jstree._reference($("#lightGroups")).hide_checkboxes();

      var AppRouter = Backbone.Router.extend ({
	  routes: {
	      "programs": "programsView",
	      "controls": "controlsView",
	      "test": "testView",
	      "help": "helpView",
	      "groups": "groupsView",
	      "": "controlsView"
	  },

	  controlsView: function() {
	      $("#controlsLightGroups").empty();
	      $.jstree._reference($("#lightGroups")).show_checkboxes();
	      $("#lightGroups").show();
	      $("#controlsLightGroups").append($("#lightGroups"));
	      var menu = new ProgramList.MultipleChoiceMenu ({ el: $("#controlsProgramsList"), model: Programs});
	      
	  },

	  groupsView: function () {
	      $("#groupsLightGroups").empty();
	      $.jstree._reference($("#lightGroups")).hide_checkboxes();
	      $("#lightGroups").show();
	      $("#groupsLightGroups").append($("#lightGroups"));
	  },

	  programsView: function () {
	      $("#programsLightGroups").empty();
	      $.jstree._reference($("#lightGroups")).show_checkboxes();
	      $("#lightGroups").show();
	      $("#programsLightGroups").append($("#lightGroups"));
	      var menu = new ProgramList.SingleChoiceMenu ({ el: $("#controlsProgramsList"), model: Programs});

	  },

	  helpView: function () {
	  },

	  testView: function () {
	      $("#test").html ("<div id='testLight'></div>");

	      var line = new ProgramLine.ProgramLine({ lineid: 1, urlRoot: "../server/programs/1/lines"});
	      ProgramView = new ProgramLine.ProgramLineView ({el: $("#testLight"), model: line});
	      line.fetch({success: function() { console.log (line); line.trigger ("reset")}});
	      setTimeout (function () { line.trigger ("change");  }, 5000);

/*	      var LightCollectionTest = Backbone.Collection.extend ({
		  model: Light.Light,
		  url: "../server/lights"
	      });
	      
	      Lights = new LightCollectionTest;

	      var ProgramObj = new ProgramLine.ProgramLine({name: "ohjelma"});
	      ProgramView = new ProgramLine.ProgramLineView ({el: $("#testLight"), model: ProgramObj});
	      
	      Lights.fetch( { success: function (lights, response) { lights.each (function (light) {ProgramView.addLight (light)})}});
*/	      
	  }
	  
      });
      var appRouter = new AppRouter;
      Backbone.history.start();

    </script>
  </body>
</html>
